---
title: "Of R and APIs: Running R in Amazon Lambda"
author: "Mike Badescu, PhD"
date: "March 24, 2018"
output:
  ioslides_presentation:
    css: style.css
    highlight: pygments
    logo: Numeract_Icon.png
    widescreen: yes
  slidy_presentation:
    css: style.css
---

## Of R and APIs: Running R in Amazon Lambda

- Slides: <https://numeract.github.io/aws-lambda-r/>  

- Code: <https://github.com/numeract/aws-lambda-r>  
- Demo: <https://github.com/numeract/aws-lambda-r-demo>  
<br>

**Mike Badescu, PhD**  

- [*mike*.*badescu@numeract*.*com*](*mike*.*badescu@numeract*.*com*)  
- @[MikeBadescu](https://twitter.com/MikeBadescu)  
<br>

**Dallas R Users Group**  
*March 24, 2018*


## About

**[Numeract LLC:](http://numeract.com/)**

- Data Science and Economics / Finance consulting services  
- Technology Stack: (Postgre)SQL, R, Python, Spark, Docker, AWS

<br>

**Code Authors and Contributors:**

- [Mike Badescu](https://www.linkedin.com/in/mikebadescu)
    + PhD Economics, Lehigh University
    + Experience: Economics, Finance, Statistics, Machine Learning
- Ana Niculescu
- Teodor Ciuraru


## Summary 

1. Motivation

2. Plumber

3. OpenCPU

4. R on Amazon Lambda


## Motivation

Data Product Progression:

1. Exploratory Data Analysis
    + get the data
    + some cleaning too
2. Proof of Concept
    + R Markdown report
3. Stakeholder Engagement and Validation
    + Shiny App
    + Iterate steps 1-3 as needed


## Motivation

4.&nbsp;**Can we use it in production?**

- _Is Shiny scalable?_
- _We already have a dashboard, we do not use Shiny._
- _Can we use the current R code but without Shiny?_
- _How do we integrate it with our current code base?_

<br>

- Rewriting the code in other programming language is not efficient
- Certain algorithms are not available in other programming languages


## Solutions

- Install R on the same machine as the production server
    + Increases chases on failure, maintenance issues
- R running inside of a VM next to other VMs
    + _How do we connect to it?_
    + _Use files? Read from a Database?_
- API
    + _Can we have an API?_
    + _Can it be a REST API?_


## API

- Modularize the application: calls from Client to Server
- Programming language independent
- Common concept: programmers know how to work with APIs
- Common "data language": **JSON** (but not the only one)
- REST API
    + stateless --> pure functions
    + over HTTP, browsable
- Over HTTP, two main methods:
    + **GET**: sends a request to a server and waits for data
    + **POST**: sends data to the server and wait for an answer


## API Example

HackerNews API

- <https://github.com/HackerNews/API>
- <https://hacker-news.firebaseio.com/v0/item/8863.json?print=pretty>
```{json}
{
  "by" : "dhouston",
  "descendants" : 71,
  "id" : 8863,
  "kids" : [ 9224, 8952, 8917, 8884, 8887, 8943, 8869, 8940, 8958, 9005, 9671, 9067, 8908, 9055, 8865, 8881, 8872, 8873, 8955, 10403, 8903, 8928, 9125, 8998, 8901, 8902, 8907, 8894, 8870, 8878, 8980, 8934, 8876 ],
  "score" : 104,
  "time" : 1175714200,
  "title" : "My YC app: Dropbox - Throw away your USB drive",
  "type" : "story",
  "url" : "http://www.getdropbox.com/u/2/screencast.html"
}
```

## API Example

Facebook Graph API

- <https://developers.facebook.com/docs/graph-api/overview>
- <https://graph.facebook.com/facebook/picture?redirect=false>
```{json}
{
   "data": {
      "height": 50,
      "is_silhouette": false,
      "url": "https://scontent.xx.fbcdn.net/v/t1.0-1/p50x50/12006203_10154088276211729_2432197377106462187_n.png?_nc_cat=0&oh=1bed18a469fcbdacc40cd0563d606bef&oe=5B3AF323",
      "width": 50
   }
}
```


## API Calls

Main Tool: **[curl](https://curl.haxx.se/)**

- free and open source
- can handle: FTP, FTPS, HTTP, HTTPS, IMAP, SCP, etc.
- deals with SSL certifcates, cookies, HTTP headers, etc.
- R packages:
    + [curl](https://cran.r-project.org/package=curl) by Jeroen Ooms
    + [RCurl](https://cran.r-project.org/package=RCurl) by Duncan Temple Lang and the CRAN team


## API Example

Facebook Graph API: using curl from [Git BASH](https://gitforwindows.org/)

![](curl.png)


## R and API

**Can we serve API requests from R?**

- not directly, as R is not a web server
- we need a wrapper / server that:
    + receives requests and handles them to R
    + passes any response from R to the client

**Approaches**

- web server: 
    + plumber and OpenCPU
- serverless: wrap R functions inside FasS (Functions as a Service)
    + running R on AWS Lambda

## plumber

_An R package that generates a web API from the R code you already have._

- main author: Jeff Allen
- pacakge website: <https://www.rplumber.io/>


## plumber

```{r, eval=FALSE}
#* @get /mean
normalMean <- function(samples=10){
  data <- rnorm(samples)
  mean(data)
}

#* @post /sum
addTwo <- function(a, b){
  as.numeric(a) + as.numeric(b)
}
```

## References {.smaller}

- Trestle Technology, LLC. 2017. [_Plumber: An API Generator for R._](https://www.rplumber.io/)

## sessionInfo() {.smaller}

```{r, echo=FALSE}
sessionInfo()
```
